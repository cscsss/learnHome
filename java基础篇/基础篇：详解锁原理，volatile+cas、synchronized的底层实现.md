<section id="nice" data-tool="mdnice编辑器" data-website="https://www.mdnice.com" style="font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;"><ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">随着多进程多线程的出现，对共享资源(设备，数据等)的竞争往往会导致资源的使用表现为随机无序</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">例如：一个线程想在控制台输出"I am fine"，刚写到"I am"，就被另一线程抢占控制台输出"naughty"，导致结果是"I am naughty"；对于资源的被抢占使用，我们能怎么办呢？当然不是凉拌，可使用锁进行同步管理，使得资源在加锁期间，其他线程不可抢占使用</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">1 锁的分类</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">悲观锁
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">悲观锁，每次去请求数据的时候，都认为数据会被抢占更新(悲观的想法)；所以每次操作数据时都要先加上锁，其他线程修改数据时就要等待获取锁。适用于写多读少的场景，synchronized就是一种悲观锁</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">乐观锁
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">在请求数据时，觉得无人抢占修改。等真正更新数据时，才判断此期间别人有没有修改过(预先读出一个版本号或者更新时间戳，更新时判断是否变化，没变则期间无人修改)；和悲观锁不同的是，期间数据允许其他线程修改</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">自旋锁
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">一句话，魔力转转圈。当尝试给资源加锁却被其他线程先锁定时，不是阻塞等待而是循环再次加锁</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">在锁常被短暂持有的场景下，线程阻塞挂起导致CPU上下文频繁切换，这可用自旋锁解决；但自旋期间它占用CPU空转，因此不适用长时间持有锁的场景</section></li></ul>
</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">2 synchronized底层原理</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">代码使用synchronized加锁，在编译之后的字节码是怎样的呢</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Test</span> </span>{
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">static</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">main</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(String[] args)</span></span>{
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">synchronized</span>(Test.class){
<span/>            System.out.println(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"hello"</span>);
<span/>        }
<span/>    }
<span/>}
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">截取部分字节码，如下</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">    <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">4</span>: monitorenter
<span/>    <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">5</span>: getstatic    #<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">9</span>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">// Field java/lang/System.out:Ljava/io/PrintStream; </span>
<span/>    <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">8</span>: ldc           #<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">15</span>   <span class="hljs-comment" style="color: #007400; line-height: 26px;">// String hello</span>
<span/>    <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">10</span>: invokevirtual #<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">17</span>  <span class="hljs-comment" style="color: #007400; line-height: 26px;">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
<span/>    <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">13</span>: aload_1
<span/>    <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">14</span>: monitorexit
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">字节码出现了4: monitorenter和14: monitorexit两个指令；字面理解就是监视进入，监视退出。可以理解为代码块执行前的加锁，和退出同步时的解锁</p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">那monitorenter和monitorexit，又背着我们干了啥呢？</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">执行monitorenter指令时，线程会为锁对象关联一个ObjectMonitor对象</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">objectMonitor.<span class="hljs-function" style="line-height: 26px;">cpp
<span/>  <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">ObjectMonitor</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{
<span/>    _header       = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>;
<span/>    _count        = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>;   \\用来记录获取该锁的线程数
<span/>    _waiters      = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>,
<span/>    _recursions   = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>;    \\锁的重入次数
<span/>    _object       = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>;
<span/>    _owner        = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>;  \\当前持有ObjectMonitor的线程
<span/>    _WaitSet      = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>;  \\wait()方法调用后的线程等待队列
<span/>    _WaitSetLock  = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> ;
<span/>    _Responsible  = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span> ;
<span/>    _succ         = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span> ;
<span/>    _cxq          = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span> ; \\阻塞等待队列
<span/>    FreeNext      = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span> ;
<span/>    _EntryList    = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span> ; \\synchronized 进来线程的排队队列
<span/>    _SpinFreq     = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> ;
<span/>    _SpinClock    = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> ;  \\自旋计算
<span/>    OwnerIsThread = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> ;
<span/>  }
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">每个线程都有两个ObjectMonitor对象列表，分别为free和used列表，如果当前free列表为空，线程将向全局global list请求分配ObjectMonitor</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">ObjectMonitor的owner、WaitSet、Cxq、EntryList这几个属性比较关键。WaitSet、Cxq、EntryList的队列元素是包装线程后的对象-ObjectWaiter；而获取owner的线程，既为获得锁的线程</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><strong style="font-weight: bold; color: black;">monitorenter对应的执行方法</strong></section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> ATTR ObjectMonitor::enter(TRAPS)  {
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//获取锁：cmpxchg_ptr原子操作，尝试将_owner替换为自己，并返回旧值</span>
<span/>    cur = Atomic::cmpxchg_ptr (Self, &amp;_owner, <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>) ;
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">// 重复获取锁，次数加1，返回</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (cur == Self) {
<span/>        _recursions ++ ;
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> ;
<span/>    }
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//首次获取锁情况处理</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (Self-&gt;is_lock_owned ((address)cur)) {
<span/>        assert (_recursions == <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>, <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"internal state error"</span>);
<span/>        _recursions = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span> ;
<span/>        _owner = Self ;
<span/>        OwnerIsThread = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span> ;
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> ;
<span/>    }
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//尝试自旋获取锁</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (Knob_SpinEarly &amp;&amp; TrySpin (Self) &gt; <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>) {
<span/>    ...
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><strong style="font-weight: bold; color: black;">monitorexit对应的执行方</strong>法<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">void ATTR ObjectMonitor::exit(TRAPS)...</code>代码太长，就不贴了。主要是recursions减1、count减少1或者如果线程不再持有owner(非重入加锁)则设置owner为null，退锁的持有状态，并唤醒Cxq队列的线程</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;"><strong style="font-weight: bold; color: black;">总结</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">线程遇到synchronized同步时，先会进入EntryList队列中，然后尝试把owner变量设置为当前线程，同时monitor中的计数器count加1，即获得对象锁。否则通过<strong style="font-weight: bold; color: black;">尝试自旋一定次数加锁</strong>，失败则进入Cxq队列阻塞等待
<img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e1691b20b?w=823&h=683&f=png&s=79613" alt style="display: block; margin: 0 auto; max-width: 100%;"></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">线程执行完毕将释放持有的owner，owner变量恢复为null，count自减1，以便其他线程进入获取锁
<img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e168b74fb?w=1002&h=483&f=png&s=59567" alt style="display: block; margin: 0 auto; max-width: 100%;"></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">synchronized修饰方法原理也是类似的。只不过没用monitor指令，而是使用ACC_SYNCHRONIZED标识方法的同步</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> synchronized <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">lock</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span></span>{
<span/>        System.out.println(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"world"</span>);
<span/>    }
<span/>....
<span/>  <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> synchronized <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">lock</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span></span>;
<span/>    descriptor: ()V
<span/>    flags: (<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0x0029</span>) ACC_PUBLIC, ACC_SYNCHRONIZED
<span/>    Code:
<span/>      <span class="hljs-built_in" style="color: #5c2699; line-height: 26px;">stack</span>=<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">2</span>, locals=<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>, args_size=<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>
<span/>         <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>: getstatic     #<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">20</span>                 <span class="hljs-comment" style="color: #007400; line-height: 26px;">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
<span/>         <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">3</span>: ldc           #<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">26</span>                 <span class="hljs-comment" style="color: #007400; line-height: 26px;">// String world</span>
<span/>         <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">5</span>: invokevirtual #<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">28</span>                 <span class="hljs-comment" style="color: #007400; line-height: 26px;">// Method java/io/PrintStream.println:(Ljava/lang/String;)V</span>
<span/>
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">synchronized是可重入，非公平锁，因为entryList的线程会先自旋尝试加锁，而不是加入cxq排队等待，不公平</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">3 Object的wait和notify方法原理</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">wait，notify必须是持有当前对象锁Monitor的线程才能调用 (对象锁代指ObjectMonitor/Monitor，锁对象代指Object)</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">上面有说到，当在sychronized中锁对象Object调用wait时会加入waitSet队列，WaitSet的元素对象就是ObjectWaiter</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">ObjectWaiter</span> : <span class="hljs-title" style="color: #5c2699; line-height: 26px;">public</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">StackObj</span> </span>{
<span/> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span>:
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">enum</span> TStates { TS_UNDEF, TS_READY, TS_RUN, TS_WAIT, TS_ENTER, TS_CXQ } ;
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">enum</span> Sorted  { PREPEND, APPEND, SORTED } ;
<span/>  ObjectWaiter * <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> _next;
<span/>  ObjectWaiter * <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> _prev;
<span/>  Thread*       _thread;
<span/>  ParkEvent *   _event;
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span>  _notified ;
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> TStates TState ;
<span/>  Sorted        _Sorted ;           <span class="hljs-comment" style="color: #007400; line-height: 26px;">// List placement disposition</span>
<span/>  bool          _active ;           <span class="hljs-comment" style="color: #007400; line-height: 26px;">// Contention monitoring is enabled</span>
<span/> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span>:
<span/>  ObjectWaiter(Thread* thread);
<span/>  <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">wait_reenter_begin</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(ObjectMonitor *mon)</span></span>;
<span/>  <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">wait_reenter_end</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(ObjectMonitor *mon)</span></span>;
<span/>};
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;"><strong style="font-weight: bold; color: black;">调用对象锁的wait()方法时，线程会被封装成ObjectWaiter，最后使用park方法挂起</strong></p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//objectMonitor.cpp</span>
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> ObjectMonitor::wait(jlong millis, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">bool</span> interruptible, TRAPS){
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//线程封装成 ObjectWaiter对象</span>
<span/>    <span class="hljs-function" style="line-height: 26px;">ObjectWaiter <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">node</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(Self)</span></span>;
<span/>    node.TState = ObjectWaiter::TS_WAIT ;
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//一系列判断操作，当线程确实加入WaitSet时，则使用park方法挂起</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (node._notified == <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>) {
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (millis &lt;= <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>) {
<span/>            Self-&gt;_ParkEvent-&gt;park () ;
<span/>        } <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">else</span> {
<span/>            ret = Self-&gt;_ParkEvent-&gt;park (millis) ;
<span/>        }
<span/>    }
<span/>
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;"><strong style="font-weight: bold; color: black;">而当对象锁使用notify()时</strong></p>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">如果waitSet为空，则直接返回</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">waitSet不为空从waitSet获取一个ObjectWaiter，然后根据不同的Policy加入到EntryList或通过<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">Atomic::cmpxchg_ptr</code>指令自旋操作加入<strong style="font-weight: bold; color: black;">cxq队列</strong>或者直接unpark唤醒</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> ObjectMonitor::notify(TRAPS){
<span/>    CHECK_OWNER();
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//waitSet为空，则直接返回</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (_WaitSet == <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>) {
<span/>        TEVENT (Empty-Notify) ;
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> ;
<span/>    }
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//通过DequeueWaiter获取_WaitSet列表中的第一个ObjectWaiter</span>
<span/>    Thread::SpinAcquire (&amp;_WaitSetLock, <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"WaitSet - notify"</span>) ;
<span/>    ObjectWaiter * iterator = DequeueWaiter() ;
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (iterator != <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>) {
<span/>    ....
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (Policy == <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">2</span>) {      <span class="hljs-comment" style="color: #007400; line-height: 26px;">// prepend to cxq</span>
<span/>         <span class="hljs-comment" style="color: #007400; line-height: 26px;">// prepend to cxq</span>
<span/>         <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (List == <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span>) {
<span/>             iterator-&gt;_next = iterator-&gt;_prev = <span class="hljs-literal" style="color: #aa0d91; line-height: 26px;">NULL</span> ;
<span/>             _EntryList = iterator ;
<span/>         } <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">else</span> {
<span/>            iterator-&gt;TState = ObjectWaiter::TS_CXQ ;
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">for</span> (;;) {
<span/>                ObjectWaiter * Front = _cxq ;
<span/>                iterator-&gt;_next = Front ;
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (Atomic::cmpxchg_ptr (iterator, &amp;_cxq, Front) == Front) {
<span/>                    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">break</span> ;
<span/>                }
<span/>            }
<span/>         }
<span/>     }
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Object的notifyAll方法则对应<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">voidObjectMonitor::notifyAll(TRAPS)</code>，流程和notify类似。不过会通过for循环取出WaitSet的ObjectWaiter节点，再依次唤醒所有线程</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">4 jvm对synchronized的优化</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">先介绍下32位JVM下JAVA对象头的结构
<img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e18510cac?w=923&h=286&f=png&s=33097" alt style="display: block; margin: 0 auto; max-width: 100%;"></p>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">偏向锁</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">未加锁的时候，锁标志为01，包含哈希值、年龄分代和偏向锁标志位(0)</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">施加偏向锁时，哈希值和一部分无用内存会转化为锁主人的线程信息，以及加锁时的时间戳epoch，此时锁标志位没变，偏向锁标志改为1</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">加锁时先判断当前线程id是否与MarkWord的线程id是否一致，一致则执行同步代码；不一致则检查偏向标志是否偏向，未偏向则使用CAS加锁；<strong style="font-weight: bold; color: black;">未偏向CAS加锁失败</strong>和<strong style="font-weight: bold; color: black;">存在偏向锁</strong>会导致偏向锁膨胀为轻量级锁，或者重新偏向</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">偏向锁只有遇到其他线程竞争偏向锁时，持有偏向锁的线程才会释放锁，线程不会主动去释放偏向锁</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">轻量级锁</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">当发生多个线程竞争时，偏向锁会变为轻量级锁，锁标志位为00</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">获得锁的线程会先将偏向锁撤销(在安全点)，并在栈桢中创建锁记录LockRecord，对象的MarkWord被复制到刚创建的LockRecord，然后CAS尝试将记录LockRecord的owner指向锁对象，再将锁对象的MarkWord指向锁，加锁成功</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">如果CAS加锁失败，线程会<strong style="font-weight: bold; color: black;">自旋一定次数加锁</strong>，再失败则升级为重量级锁
<img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e1d0c9ae1?w=977&h=650&f=png&s=83778" alt style="display: block; margin: 0 auto; max-width: 100%;"></section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">重量级锁</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">重量级锁就是上面介绍到synchronized使用监视器Monitor实现的锁机制</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">竞争线程激烈，锁则继续膨胀，变为重量级锁，也是互斥锁，锁标志位为10，MarkWord其余内容被替换为一个指向对象锁Monitor的指针</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">自旋锁</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">减少不必要的CPU上下文切换；在轻量级锁升级为重量级锁时，就使用了自旋加锁的方式</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><p style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">锁粗化</p>
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">多次加锁操作在JVM内部也是种消耗，如果多个加锁可以合并为一个锁，就可减少不必要的开销</section></li></ul>
</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">Test.class
<span/><span class="hljs-comment" style="color: #007400; line-height: 26px;">//编译器会考虑将两次加锁合并</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">test</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span></span>{
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">synchronized</span>(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">this</span>){
<span/>        System.out.println(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"hello"</span>);   
<span/>    }
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">synchronized</span>(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">this</span>){
<span/>        System.out.println(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"world"</span>);   
<span/>    }
<span/>}
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">锁消除
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">删除不必要的加锁操作，如果变量是独属一个线程的栈变量，加不加锁都是安全的，编译器会尝试消除锁</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">开启锁消除需要在JVM参数上设置<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">-server -XX:+DoEscapeAnalysis -XX:+EliminateLocks</code></section></li></ul>
</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//StringBuffer的append操作会加上synchronized，</span>
<span/><span class="hljs-comment" style="color: #007400; line-height: 26px;">//但是变量buf不加锁也安全的，编译器会把锁消除</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">test</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{
<span/>    StringBuffer buf = <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">new</span> StringBuffer();
<span/>    buf.append(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"hello"</span>).append(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"world"</span>);
<span/>}
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">其他锁优化方法
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">分段锁，分段锁也并非一种实际的锁，而是一种思想；ConcurrentHashMap是学习分段锁的最好实践。主要是将大对象拆成小对象，然后对大对象的加锁操作变成对小对象加锁，增加了并行度</section></li></ul>
</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">5 CAS的底层原理</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">在<code style="font-size: 14px; word-wrap: break-word; padding: 2px 4px; border-radius: 4px; margin: 0 2px; background-color: rgba(27,31,35,.05); font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; word-break: break-all; color: #009688;">volatile int i = 0; i++</code>中，volatile类型的读写是原子同步的，但是i++却不能保证同步性，我们该怎么呢？</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">可以使用synchronized加锁；还有就是用CAS(比较并交换)，使用乐观锁的思想同步，先判断共享变量是否改变，没有则更新。下面看看不同步版本的CAS</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> expectedValue = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>;
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">compareAndSet</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> newValue)</span> </span>{
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span>(expectedValue == <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>){
<span/>        expectedValue = newValue;
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> ture;
<span/>    }
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">false</span>;
<span/>}
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">在jdk是有提供同步版的CAS解决方案，其中使用了UnSafe.java的底层方法</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//UnSafe.java</span>
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@HotSpotIntrinsicCandidate</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">native</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">compareAndSetInt</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(Object o, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">long</span> offset, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> expected, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> x)</span> ..
<span/>    @HotSpotIntrinsicCandidate
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">native</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">compareAndExchangeInt</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(Object o, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">long</span> offset, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> expected, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> x)</span>...
<span/></span></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">我们再来看看本地方法，Unsafe.cpp中的compareAndSwapInt</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//unsafe.cpp</span>
<span/>UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x))
<span/>  UnsafeWrapper(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"Unsafe_CompareAndSwapInt"</span>);
<span/>  oop p = JNIHandles::resolve(obj);
<span/>  jint* addr = (jint *) index_oop_from_field_offset_long(p, offset);
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> (jint)(Atomic::cmpxchg(x, addr, e)) == e;
<span/>UNSAFE_END
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">在Linux的x86，Atomic::cmpxchg方法的实现如下</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">/**
<span/>    1 __asm__表示汇编的开始；
<span/>    2 volatile表示禁止编译器优化；//禁止指令重排
<span/>    3 LOCK_IF_MP是个内联函数，
<span/>      根据当前系统是否为多核处理器，
<span/>      决定是否为cmpxchg指令添加lock前缀 //内存屏障
<span/>*/</span>
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">inline</span> jint Atomic::cmpxchg (jint exchange_value, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> jint* dest, jint compare_value) {
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> mp = os::is_MP();
<span/>  __<span class="hljs-function" style="line-height: 26px;">asm__ <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">volatile</span> <span class="hljs-params" style="color: #5c2699; line-height: 26px;">(LOCK_IF_MP(%<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">4</span>) <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"cmpxchgl %1,(%3)"</span>
<span/>                    : <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"=a"</span> (exchange_value)
<span/>                    : <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"r"</span> (exchange_value), <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"a"</span> (compare_value), <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"r"</span> (dest), <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"r"</span> (mp)
<span/>                    : <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"cc"</span>, <span class="hljs-string" style="color: #c41a16; line-height: 26px;">"memory"</span>)</span></span>;
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> exchange_value;
<span/>}
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">到这一步，可以总结到：<strong style="font-weight: bold; color: black;">jdk提供的CAS机制，在汇编层级，会禁止变量两侧的指令优化，然后使用cmpxchg指令比较并更新变量值(原子性)，如果是多核则使用lock锁定(缓存锁、MESI)</strong></p>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">6 CAS同步操作的问题</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">ABA问题
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">线程X准备将变量的值从A改为B，然而这期间线程Y将变量的值从A改为C，然后再改为A；最后线程X检测变量值是A，并置换为B。但实际上，A已经不再是原来的A了</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">解决方法，是把变量定为唯一类型。值可以加上版本号，或者时间戳。如加上版本号，线程Y的修改变为A1-&gt;B2-&gt;A3，此时线程X再更新则可以判断出A1不等于A3</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">只能保证一个共享变量的原子操作
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">只保证一个共享变量的原子操作，对多个共享变量同步时，循环CAS是无法保证操作的原子</section></li></ul>
</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">7 基于volatile + CAS 实现同步锁的原理</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">CAS只能同步一个变量的修改，我们又应该如何用它来锁住代码块呢？</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先说说实现锁的要素
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">1 同步代码块同一时刻只能有一个线程能执行</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">2 加锁操作要happens-before同步代码块里的操作，而代码块里的操作要happens-before解锁操作</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">3 同步代码块结束后相对其他线程其修改的变量是可见的 (内存可见性)</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">要素1：可以利用CAS的原子性来实现，任意时刻只有一个线程能成功操作变量
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先设想CAS操作的共享变量是一个关联代码块的同步状态变量，同步开始之前先CAS更新<strong style="font-weight: bold; color: black;">状态变量</strong>为加锁状态，同步结束之后，再CAS<strong style="font-weight: bold; color: black;">状态变量</strong>为无锁状态</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">如果期间有第二个线程来加锁，则会发现状态变量为加锁状态，则放弃执行同步代码块</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">要素2：使用volatile修饰状态变量，禁止指令重排
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">volatile保证同步代码里的操作happens-before解锁操作，而加锁操作happens-before代码块里的操作</section></li></ul>
</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">要素3：还是用volatile，volatile变量写指令前后会插入内存屏障
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">volatile修饰的状态变量被CAS为无锁状态前，同步代码块的脏数据就会被更新，被各个线程可见</section></li></ul>
</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//伪代码</span>
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> state = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> ;   <span class="hljs-comment" style="color: #007400; line-height: 26px;">// 0-无锁 1-加锁；volatile禁止指令重排，加入内存屏障</span>
<span/>...
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span>(cas(state, <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> , <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>)){ <span class="hljs-comment" style="color: #007400; line-height: 26px;">// 1 加锁成功，只有一个线程能成功加锁</span>
<span/>    ...                <span class="hljs-comment" style="color: #007400; line-height: 26px;">// 2 同步代码块</span>
<span/>    cas(state, <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>, <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>);  <span class="hljs-comment" style="color: #007400; line-height: 26px;">// 3 解锁时2的操作具有可见性</span>
<span/>}
<span/>
<span/></code></pre>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">8 LockSupport了解一下</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">LockSupport是基于Unsafe类，由JDK提供的线程操作工具类，主要作用就是<strong style="font-weight: bold; color: black;">挂起线程，唤醒线程</strong>。Unsafe.park，unpark操作时，会调用当前线程的变量parker代理执行。Parker代码</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">JavaThread* thread=JavaThread::thread_from_jni_environment(env);
<span/>...
<span/>thread-&gt;parker()-&gt;park(isAbsolute != <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>, time);
<span/></code></pre>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">PlatformParker</span> :</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> CHeapObj {
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span>:
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//互斥变量类型</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">pthread_mutex_t</span> _mutex [<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>] ; 
<span/>   <span class="hljs-comment" style="color: #007400; line-height: 26px;">//条件变量类型</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">pthread_cond_t</span>  _cond  [<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>] ;
<span/>    ...
<span/>}
<span/>
<span/><span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Parker</span> :</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> os::PlatformParker {  
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span>:  
<span/>  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> _counter ;  
<span/>  ...  
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span>:  
<span/>  <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">park</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">bool</span> isAbsolute, jlong time)</span></span>;  
<span/>  <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">unpark</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span></span>;  
<span/>  ...  
<span/>}
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">在Linux系统下，用的POSIX线程库pthread中的mutex(互斥量)，condition来实现线程的挂起、唤醒</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">注意点：当park时，counter变量被设置为0，当unpark时，这个变量被设置为1</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">unpark和park执行顺序不同时，counter和cond的状态变化如下
<ul style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: square;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先park后unpark; park：counter值不变，但会设置一个cond; unpark：counter先加1，检查cond存在，counter减为0</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先unpark后park；park：counter变为1，但不设置cond；unpark：counter减为0(线程不会因为park挂起)</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">先多次unpark；counter也只设置为为1</section></li></ul>
</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">9 LockSupport.park和Object.wait区别</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">两种方式都有具有挂起的线程的能力</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">线程在Object.wait之后必须等到Object.notify才能唤醒</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">LockSupport可以先unpark线程，等线程执行LockSupport.park是不会挂起的，可以继续执行</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">需要注意的是就算线程多次unpark；也只能让线程第一次park是不会挂起</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">10 AbstractQueuedSynchronizer(AQS)</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">AQS其实就是基于volatile+cas实现的锁模板；如果需要线程阻塞等待，唤醒机制，则使用LockSupport挂起、唤醒线程</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//AbstractQueuedSynchronizer.java</span>
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">AbstractQueuedSynchronizer</span></span>{
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//线程节点</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">static</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Node</span> </span>{
<span/>        ...
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> Node prev;
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> Node next;
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> Thread thread;
<span/>        ...
<span/>    }    
<span/>    ....
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//head 等待队列头尾节点</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">transient</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> Node head;
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">transient</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> Node tail;
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">// The synchronization state. 同步状态</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">volatile</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> state;  
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//提供CAS操作，状态具体的修改由子类实现</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">compareAndSetState</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> expect, <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> update)</span> </span>{
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> STATE.compareAndSet(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">this</span>, expect, update);
<span/>    }
<span/>}
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">AQS内部维护一个同步队列，元素就是包装了线程的Node</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">同步队列中首节点是获取到锁的节点，它在释放锁的时会唤醒后继节点，后继节点获取到锁的时候，会把自己设为首节点
<img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e1d4aaffc?w=969&h=573&f=png&s=68060" alt style="display: block; margin: 0 auto; max-width: 100%;"></section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">acquire</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> arg)</span> </span>{
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (!tryAcquire(arg) &amp;&amp;
<span/>            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
<span/>            selfInterrupt();
<span/>}
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">线程会先尝试获取锁，失败则封装成Node，CAS加入同步队列的尾部。在加入同步队列的尾部时，会判断前驱节点是否是head结点，并尝试加锁(可能前驱节点刚好释放锁)，否则线程进入阻塞等待</section></li></ul>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;"><strong style="font-weight: bold; color: black;">在AQS还存一个ConditionObject的内部类，它的使用机制和Object.wait、notify类似</strong></p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//AbstractQueuedSynchronizer.java</span>
<span/><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">ConditionObject</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">implements</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Condition</span>, <span class="hljs-title" style="color: #5c2699; line-height: 26px;">java</span>.<span class="hljs-title" style="color: #5c2699; line-height: 26px;">io</span>.<span class="hljs-title" style="color: #5c2699; line-height: 26px;">Serializable</span> </span>{
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//条件队列;Node 复用了AQS中定义的Node</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">transient</span> Node firstWaiter;
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">transient</span> Node lastWaiter;
<span/>    ...
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">每个Condition对象内部包含一个Node元素的FIFO条件队列</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">当一个线程调用Condition.await()方法，那么该线程将会释放锁、构造Node加入条件队列并进入等待状态</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-comment" style="color: #007400; line-height: 26px;">//类似Object.wait</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">await</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">throws</span> InterruptedException</span>{
<span/>    ...
<span/>    Node node = addConditionWaiter(); <span class="hljs-comment" style="color: #007400; line-height: 26px;">//构造Node,加入条件队列</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> savedState = fullyRelease(node);
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> interruptMode = <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>;
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">while</span> (!isOnSyncQueue(node)) {
<span/>        <span class="hljs-comment" style="color: #007400; line-height: 26px;">//挂起线程</span>
<span/>        LockSupport.park(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">this</span>);
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>)
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">break</span>;
<span/>    }
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//notify唤醒线程后，加入同步队列继续竞争锁</span>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)
<span/>        interruptMode = REINTERRUPT;
<span/></code></pre>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e1e5051fd?w=748&h=475&f=png&s=43427" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">调用Condition.signal时，获取条件队列的首节点，将其移动到同步队列并且利用LockSupport唤醒节点中的线程。随后继续执行wait挂起前的状态，调用acquireQueued(node, savedState)竞争同步状态</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//类似Object.notify</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">doSignal</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(Node first)</span> </span>{
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">do</span> {
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> ( (firstWaiter = first.nextWaiter) == <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">null</span>)
<span/>                lastWaiter = <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">null</span>;
<span/>            first.nextWaiter = <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">null</span>;
<span/>        } <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">while</span> (!transferForSignal(first) &amp;&amp;
<span/>                 (first = firstWaiter) != <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">null</span>);
<span/>    }
<span/></code></pre>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e3af5580a?w=813&h=551&f=png&s=52001" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><strong style="font-weight: bold; color: black;">volatile+cas机制保证了代码的同步性和可见性，而AQS封装了线程阻塞等待挂起，解锁唤醒其他线程的逻辑</strong>。AQS子类只需根据状态变量，判断是否可获取锁，是否释放锁成功即可</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">继承AQS需要选性重写以下几个接口</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryAcquire</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> arg)</span></span>;<span class="hljs-comment" style="color: #007400; line-height: 26px;">//尝试独占性加锁</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryRelease</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> arg)</span></span>;<span class="hljs-comment" style="color: #007400; line-height: 26px;">//对应tryAcquire释放锁</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryAcquireShared</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> arg)</span></span>;<span class="hljs-comment" style="color: #007400; line-height: 26px;">//尝试共享性加锁</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryReleaseShared</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> arg)</span></span>;<span class="hljs-comment" style="color: #007400; line-height: 26px;">//对应tryAcquireShared释放锁</span>
<span/><span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">isHeldExclusively</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span></span>;<span class="hljs-comment" style="color: #007400; line-height: 26px;">//该线程是否正在独占资源，只有用到condition才需要取实现它</span>
<span/></code></pre>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">11 ReentrantLock的原理</span><span class="suffix"></span></h1>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e3b0a1a21?w=689&h=569&f=png&s=44728" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">ReentrantLock实现了Lock接口，并使用内部类Sync(Sync继承AbstractQueuedSynchronizer)来实现同步操作</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">ReentrantLock内部类Sync</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">abstract</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">static</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Sync</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">AbstractQueuedSynchronizer</span></span>{
<span/>    .... 
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">nonfairTryAcquire</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> acquires)</span> </span>{
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> Thread current = Thread.currentThread();
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> c = getState();
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (c == <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>) {
<span/>                <span class="hljs-comment" style="color: #007400; line-height: 26px;">//直接CAS状态加锁，非公平操作</span>
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (compareAndSetState(<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>, acquires)) { 
<span/>                    setExclusiveOwnerThread(current);
<span/>                    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">true</span>;
<span/>                }
<span/>            }
<span/>    ...
<span/>    <span class="hljs-comment" style="color: #007400; line-height: 26px;">//重写了tryRelease</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryRelease</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> releases)</span> </span>{
<span/>        c = state - releases; <span class="hljs-comment" style="color: #007400; line-height: 26px;">//改变同步状态</span>
<span/>        ...
<span/>        <span class="hljs-comment" style="color: #007400; line-height: 26px;">//修改volatile 修饰的状态变量</span>
<span/>        setState(c); 
<span/>        <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> free;
<span/>    }
<span/>}
<span/></code></pre>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">Sync的子类NonfairSync和FairSync都重写了tryAcquire方法</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">其中NonfairSync的tryAcquire调用父类的nonfairTryAcquire方法, FairSync则自己重写tryAcquire的逻辑。其中调用hasQueuedPredecessors()判断是否有排队Node，存在则返回false（false会导致当前线程排队等待锁）</section></li></ul>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;">    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">static</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">NonfairSync</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Sync</span> </span>{
<span/>        <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryAcquire</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> acquires)</span> </span>{
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> nonfairTryAcquire(acquires);
<span/>        }
<span/>    }
<span/>    ....
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">static</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">FairSync</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Sync</span> </span>{
<span/>        <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">protected</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryAcquire</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> acquires)</span> </span>{
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> Thread current = Thread.currentThread();
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> c = getState();
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (c == <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>) {
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (!hasQueuedPredecessors() &amp;&amp;   
<span/>                    compareAndSetState(<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>, acquires)) {
<span/>                    setExclusiveOwnerThread(current);
<span/>                    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">true</span>;
<span/>                }
<span/>            }
<span/>    ....    
<span/></code></pre>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">12 AQS排他锁的实例demo</span><span class="suffix"></span></h1>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">TwinsLock</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">implements</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Lock</span> </span>{
<span/>
<span/>    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">private</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">final</span> Sync sync = <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">new</span> Sync(<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">2</span>);
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">lockInterruptibly</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">throws</span> InterruptedException </span>{  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">new</span> RuntimeException(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">""</span>); }
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryLock</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">throws</span> InterruptedException </span>{<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">new</span> RuntimeException(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">""</span>);}
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> Condition <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">newCondition</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{  <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> sync.newCondition(); }
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">lock</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{  sync.acquireShared(<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>); }
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">void</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">unlock</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{  sync.releaseShared(<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>); } }
<span/>    <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>    <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryLock</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{ <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> sync.tryAcquireShared(<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>) &gt; -<span class="hljs-number" style="color: #1c00cf; line-height: 26px;">1</span>;  }
<span/>}
<span/></code></pre>
<p data-tool="mdnice编辑器" style="font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: black; text-align: justify;">再来看看Sync的代码</p>
<pre class="custom" data-tool="mdnice编辑器" style="margin-top: 10px; margin-bottom: 10px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.55) 0px 2px 10px;"><span style="display: block; background: url(https://imgkr.cn-bj.ufileos.com/97e4eed2-a992-4976-acf0-ccb6fb34d308.png); height: 30px; width: 100%; background-size: 40px; background-repeat: no-repeat; background-color: #fff; margin-bottom: -7px; border-radius: 5px; background-position: 10px 10px;"></span><code class="hljs" style="overflow-x: auto; padding: 16px; color: black; display: block; font-family: Operator Mono, Consolas, Monaco, Menlo, monospace; font-size: 12px; -webkit-overflow-scrolling: touch; padding-top: 15px; background: #fff; border-radius: 5px;"><span class="hljs-class" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">class</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">Sync</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">extends</span> <span class="hljs-title" style="color: #5c2699; line-height: 26px;">AbstractQueuedSynchronizer</span> </span>{
<span/>        Sync(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> count) {
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (count &lt;= <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span>) {
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">throw</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">new</span> IllegalArgumentException(<span class="hljs-string" style="color: #c41a16; line-height: 26px;">"count must large than zero"</span>);
<span/>            }
<span/>            setState(count);
<span/>        }
<span/>        <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>        <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryAcquireShared</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> reduceCount)</span> </span>{
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">for</span> (; ; ) {
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> current = getState(); 
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> newCount = current - reduceCount;
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (newCount &lt; <span class="hljs-number" style="color: #1c00cf; line-height: 26px;">0</span> || compareAndSetState(current, newCount)) {
<span/>                    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> newCount;
<span/>                }
<span/>            }
<span/>        }
<span/>        <span class="hljs-meta" style="color: #643820; line-height: 26px;">@Override</span>
<span/>        <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">boolean</span> <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">tryReleaseShared</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">(<span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> returnCount)</span> </span>{
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">for</span> (; ; ) {
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> current = getState();
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">int</span> newCount = current + returnCount;
<span/>                <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">if</span> (compareAndSetState(current, newCount)) {
<span/>                    <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">true</span>;
<span/>                }
<span/>            }
<span/>        }
<span/>        <span class="hljs-function" style="line-height: 26px;"><span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">public</span> Condition <span class="hljs-title" style="color: #1c00cf; line-height: 26px;">newCondition</span><span class="hljs-params" style="color: #5c2699; line-height: 26px;">()</span> </span>{
<span/>            <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">return</span> <span class="hljs-keyword" style="color: #aa0d91; line-height: 26px;">new</span> AbstractQueuedSynchronizer.ConditionObject();
<span/>        }
<span/>    }
<span/></code></pre>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">13 使用锁，能防止线程死循环吗</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">答案是不一定的；对于单个资源来说是可以做的；但是多个资源会存在死锁的情况，例如线程A持有资源X，等待资源Y，而线程B持有资源Y，等待资源X</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">有了锁，可以对资源加状态控制，但是我们还需要防止死锁的产生，打破产生死锁的四个条件之一就行</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">1 资源不可重复被两个及以上的使用者占用</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">2 使用者持有资源并等待其他资源</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">3 资源不可被抢占</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">4 多个使用者形成等待对方资源的循环圈</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">14 ThreadLocal是否可保证资源的同步</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">当使用ThreadLocal声明变量时，ThreadLocal为每个使用该变量的线程提供独立的变量副本，每一个线程都可以独立地改变自己的副本，而不会影响其它线程所对应的副本</section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;">从上面的概念可知，ThreadLocal其实并不能保证变量的同步性，只是给每一个线程分配一个变量副本</section></li></ul>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">关注公众号，大家一起交流</span><span class="suffix"></span></h1>
<figure data-tool="mdnice编辑器" style="margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;"><img src="https://user-gold-cdn.xitu.io/2020/7/20/1736a01e6358dfe0?w=1013&h=451&f=png&s=212256" alt style="display: block; margin: 0 auto; max-width: 100%;"></figure>
<h1 data-tool="mdnice编辑器" style="margin-top: 30px; margin-bottom: 15px; padding: 0px; font-weight: bold; font-size: 1.8em; color: #009688; margin: 1.2em auto; text-align: center; border-bottom: 1px solid #009688;"><span class="prefix" style="display: none;"></span><span class="content">参考文章</span><span class="suffix"></span></h1>
<ul data-tool="mdnice编辑器" style="margin-top: 8px; margin-bottom: 8px; padding-left: 25px; color: black; list-style-type: disc;">
<li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><a href="https://github.com/openjdk-mirror/jdk7u-hotspot/blob/50bdefc3afe944ca74c3093e7448d6b889cd20d1/src/share/vm/runtime/objectMonitor.cpp" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">objectMonitor.cpp</a></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><a href="https://www.hollischuang.com/archives/2030" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">Moniter的实现原理</a></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><a href="https://www.jianshu.com/p/f4454164c017" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">JVM源码分析之Object.wait/notify实现</a></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><a href="https://www.cnblogs.com/ZoHy/p/11313155.html" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">Java对象头与锁</a></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><a href="https://blog.csdn.net/e891377/article/details/104551335/" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">LockSupport中park与unpark基本使用与原理</a></section></li><li><section style="margin-top: 5px; margin-bottom: 5px; line-height: 26px; text-align: left; color: rgb(1,1,1); font-weight: 500;"><a href="https://www.cnblogs.com/gemine/p/9039012.html" style="text-decoration: none; word-wrap: break-word; font-weight: bold; color: #009688; border-bottom: 1px solid #009688;">Java并发之Condition</a></section></li></ul>
</section>